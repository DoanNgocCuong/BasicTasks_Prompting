# 2.3 PowerShell Token Argument Parsing Issue

## ğŸ“‹ TÃ³m táº¯t váº¥n Ä‘á»

Khi cháº¡y command `python main.py --ids 8532 --token {{token}}` trong PowerShell, script bÃ¡o lá»—i:
```
usage: main.py [-h] (--ids IDS [IDS ...] | --id_file ID_FILE) [--token TOKEN]
main.py: error: argument --token: expected one argument
```

## ğŸ” Root Cause Analysis

### Váº¥n Ä‘á» chÃ­nh
PowerShell tá»± Ä‘á»™ng interpret `{{token}}` nhÆ° má»™t command substitution/expansion vÃ  thÃªm cÃ¡c parameters encoding, dáº«n Ä‘áº¿n sys.argv bá»‹ thay Ä‘á»•i khÃ´ng mong muá»‘n.

### Debug Output
```bash
# Command cháº¡y:
python main.py --ids 8532 --token {{token}}

# sys.argv thá»±c táº¿:
['main.py', '--ids', '8532', '--token', '-encodedCommand', 'ewB0AG8AawBlAG4AfQA=', '-inputFormat', 'xml', '-outputFormat', 'text']
```

### PhÃ¢n tÃ­ch chi tiáº¿t
1. PowerShell tháº¥y `{{token}}` vÃ  coi Ä‘Ã¢y lÃ  má»™t command expansion
2. PowerShell tá»± Ä‘á»™ng thÃªm cÃ¡c parameters: `-encodedCommand`, `-inputFormat`, `-outputFormat`
3. argparse tháº¥y `--token` Ä‘Æ°á»£c theo sau bá»Ÿi `-encodedCommand` thay vÃ¬ giÃ¡ trá»‹ token
4. argparse bÃ¡o lá»—i vÃ¬ `--token` cáº§n 1 argument nhÆ°ng nháº­n Ä‘Æ°á»£c flag `-encodedCommand`

## ğŸ› ï¸ Giáº£i phÃ¡p

### CÃ¡ch 1: Sá»­ dá»¥ng quotes (Recommended)
```bash
python main.py --ids 8532 --token "{{token}}"
```

### CÃ¡ch 2: Sá»­ dá»¥ng token thá»±c
```bash
python main.py --ids 8532 --token "your_actual_api_token_here"
```

### CÃ¡ch 3: Sá»­ dá»¥ng biáº¿n mÃ´i trÆ°á»ng
```powershell
$env:TOKEN="your_actual_token"
python main.py --ids 8532 --token $env:TOKEN
```

### CÃ¡ch 4: Escape characters
```bash
python main.py --ids 8532 --token `{{token}`}
```

## ğŸ§ª Testing & Verification

### Táº¡o debug script
ÄÃ£ táº¡o `debug_args.py` Ä‘á»ƒ test argument parsing:
```python
#!/usr/bin/env python3
"""
Debug script Ä‘á»ƒ test argument parsing
"""
import sys
import argparse

def debug_parse_arguments():
    print(f"ğŸ” DEBUG: sys.argv = {sys.argv}")
    # ... rest of debug code
```

### Test results
```bash
# âŒ FAILED - Without quotes:
python debug_args.py --ids 8532 --token {{token}}
# sys.argv = ['debug_args.py', '--ids', '8532', '--token', '-encodedCommand', 'ewB0AG8AawBlAG4AfQA=', ...]

# âœ… SUCCESS - With quotes:
python debug_args.py --ids 8532 --token "{{token}}"
# sys.argv = ['debug_args.py', '--ids', '8532', '--token', '{{token}}']
```

## ğŸ”§ Code Changes Made

### 1. Enhanced Debugging in main.py
```python
def parse_arguments():
    print("ğŸ” DEBUG: Parsing command line arguments...")
    print(f"ğŸ” DEBUG: sys.argv = {sys.argv}")
    
    # ... existing code ...
    
    args = parser.parse_args()
    
    # Debug thÃ´ng tin arguments
    print(f"ğŸ” DEBUG: Parsed arguments:")
    print(f"ğŸ” DEBUG: args.token = '{args.token}'")
    
    return args
```

### 2. Enhanced Error Handling
```python
def main():
    try:
        args = parse_arguments()
    except SystemExit as e:
        print(f"âŒ DEBUG: SystemExit caught during argument parsing: {e}")
        print(f"ğŸ” DEBUG: Exit code: {e.code}")
        raise
    
    # Token validation
    if args.token == '{{token}}':
        print("âš ï¸ WARNING: Token appears to be a placeholder '{{token}}'")
        print("   Examples:")
        print("   - python main.py --ids 8532 --token your_actual_token_here")
        print("   - export TOKEN=your_token && python main.py --ids 8532 --token $TOKEN")
```

### 3. Created Debug Script
Táº¡o `debug_args.py` vá»›i detailed sys.argv inspection Ä‘á»ƒ dá»… dÃ ng troubleshoot argument parsing issues.

## ğŸš¨ Platform-Specific Issues

### PowerShell vs Bash/Zsh
- **PowerShell**: Cáº§n quotes Ä‘á»ƒ avoid command expansion
- **Bash/Zsh**: `{{token}}` khÃ´ng cÃ³ special meaning, khÃ´ng cáº§n quotes

### Windows CMD
```cmd
python main.py --ids 8532 --token {{token}}
# Should work without quotes in CMD
```

## ğŸ“ Prevention Measures

### 1. Documentation Update
- ThÃªm examples vá»›i quotes trong README
- Ghi chÃº platform-specific requirements

### 2. Improved Error Messages
```python
parser.add_argument('--token', type=str, default='{{token}}', 
                   help='API token. Use quotes in PowerShell: --token "{{token}}"')
```

### 3. Validation Logic
```python
if args.token == '{{token}}':
    print("âš ï¸ WARNING: Using placeholder token")
    print("   For PowerShell users: use quotes around {{token}}")
```

## ğŸ”— Related Files

- `main.py` - Main script vá»›i enhanced debugging
- `debug_args.py` - Debug utility for argument parsing
- `get_data_conversation.py` - Working fine vÃ¬ khÃ´ng cÃ³ command line parsing
- `cmd_run.sh` - Bash script (khÃ´ng bá»‹ affected)

## ğŸ“Š Impact Assessment

### Before Fix
- âŒ PowerShell users gáº·p error khÃ´ng rÃµ nguyÃªn nhÃ¢n
- âŒ KhÃ´ng cÃ³ debug information
- âŒ Script fail ngay tá»« argument parsing

### After Fix
- âœ… Clear error messages vá»›i debug info
- âœ… Platform-specific guidance
- âœ… Multiple solution options
- âœ… Debug utility available

## ğŸ¯ Lessons Learned

1. **Platform differences matter**: PowerShell cÃ³ behavior khÃ¡c bash/zsh
2. **Debug early**: sys.argv inspection giÃºp identify root cause nhanh
3. **User-friendly errors**: Cung cáº¥p clear guidance vÃ  examples
4. **Test across platforms**: Command line parsing cÃ³ thá»ƒ khÃ¡c nhau
5. **Quote when in doubt**: Safer approach cho special characters

## ğŸ”® Future Improvements

1. **Auto-detect shell**: Detect PowerShell vÃ  show appropriate warnings
2. **Config file support**: TrÃ¡nh command line arguments phá»©c táº¡p
3. **Environment variable defaults**: Tá»± Ä‘á»™ng load tá»« .env file
4. **Cross-platform testing**: CI/CD testing trÃªn multiple shells

---

**Date**: 2025-01-19  
**Author**: Debug Session  
**Status**: âœ… Resolved  
**Priority**: High (affects user experience)